<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STARLUX Crew Salary Calculator</title>
  <style>
    /* * STARLUX 2026 THEME - SPLIT LOGO EDITION
     * 1. Pantone 10393 C (Premium Slate): #262b2f
     * 2. Cloud Dancer (Off-White): #F0EEE9
     * 3. Pantone 876 C (Bronze): #8B6F4E
     * 4. Pantone 871 C (Olive Gold): #84754E
     */
    :root{
      /* --- 核心色票 --- */
      --c-slate:   #262b2f;  
      --c-cloud:   #F0EEE9; 
      --c-bronze:  #8B6F4E; 
      --c-olive:   #84754E; 

      /* --- 衍生色 --- */
      --c-card:    #2e3338;
      --c-input:   #1f2326;
      --c-muted:   #9ca3af;
      --c-border:  rgba(132, 117, 78, 0.3);

      /* 狀態色 */
      --s-good-bg: rgba(139, 111, 78, 0.15);
      --s-good-fg: #bf9e74; 
      --s-warn-bg: rgba(132, 117, 78, 0.15);
      --s-warn-fg: #a89f85;
      --s-bad-bg:  rgba(0, 0, 0, 0.2);
      --s-bad-fg:  #555; 

      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --radius: 6px; 
      
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box}

    body{
      margin:0; 
      background-color: var(--c-slate);
      background-image: linear-gradient(160deg, #222629 0%, #2a2f34 100%);
      color: var(--c-cloud); 
      font-family: var(--sans);
      min-height: 100vh;
      display: flex; 
      justify-content: center;
    }

    .wrap{
      width: 100%; 
      max-width: 98%; 
      margin: 20px auto; 
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* === LOGO 特殊處理區 (Split Logo) === */
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 5px;
      padding-top: 10px;
      height: 60px; 
      gap: 0; /* 緊密排列 */
    }

    /* 定義 Logo 圖片的高度 */
    .logo-h { height: 45px; display: block; }

    /* 左邊：顯示圖形 (Symbol) */
    .logo-left-crop {
      overflow: hidden;
      /* 這裡的 width 決定要露出多少左邊的圖形，如果不夠寬可以微調 */
      width: 58px; 
      position: relative;
    }
    .logo-left-crop img {
      /* 保持原色，不做任何濾鏡 */
      object-fit: cover;
      object-position: left top; /* 靠左對齊 */
    }

    /* 右邊：顯示文字 (Text) */
    .logo-right-crop {
      overflow: hidden;
      /* 剩下的寬度給文字 */
      width: 180px; 
      position: relative;
    }
    .logo-right-crop img {
      /* 向左推移，把左邊的圖形藏起來，只顯示文字 */
      margin-left: -58px; 
      
      /* ✅ 關鍵濾鏡：把原本黑色的文字轉成「香檳金」 */
      /* 1. brightness(0) invert(1) -> 變全白 */
      /* 2. sepia(1) -> 變復古黃 */
      /* 3. opacity(0.9) -> 微調亮度 */
      filter: brightness(0) invert(1) sepia(0.2) opacity(0.9);
    }

    /* 頂部通知 */
    .topnote{
      background: var(--s-warn-bg);
      border-left: 3px solid var(--c-olive);
      color: var(--c-cloud);
      padding: 16px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.6;
      box-shadow: var(--shadow);
    }
    .topnote b { color: var(--c-bronze); }

    /* 卡片設計 */
    .card{
      background: var(--c-card);
      border: 1px solid var(--c-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card h2{
      margin:0; padding: 16px 24px; 
      font-size: 14px; 
      letter-spacing: 1.5px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--c-border);
      color: var(--c-bronze);
      background: rgba(0,0,0,0.1);
      font-weight: 600;
    }

    .content{padding: 24px;}

    /* 輸入區排版 */
    .row{
      display:grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 40px; 
      margin-bottom: 24px;
    }
    @media (max-width: 800px){ .row{grid-template-columns:1fr; gap: 16px;} }

    label{
      display:block; 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 1px;
      color: var(--c-muted); 
      margin-bottom: 8px;
    }

    input, select, textarea{
      width:100%;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--c-input);
      color: var(--c-cloud);
      outline: none;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--c-bronze);
    }

    textarea{
      min-height: 200px; 
      resize:vertical; 
      font-family:var(--mono); 
      font-size:13px; 
      line-height:1.5;
      border-left: 3px solid var(--c-bronze);
    }

    .btnrow{display:flex; gap:12px; flex-wrap:wrap; margin-top:24px}

    button{
      padding: 10px 24px; 
      border-radius: 2px;
      cursor:pointer;
      border: 1px solid var(--c-olive);
      background: transparent;
      color: var(--c-cloud);
      font-size: 13px;
      letter-spacing: 1px;
      transition: all 0.3s;
    }
    button:hover{
      background: rgba(132, 117, 78, 0.1);
      border-color: var(--c-bronze);
    }

    button.primary{
      background: var(--c-bronze);
      border-color: var(--c-bronze);
      color: #fff;
      font-weight: 600;
    }
    button.primary:hover{
      background: #7a6143;
      border-color: #7a6143;
    }

    /* KPI 儀表板 */
    .kpis{
      display:grid; 
      grid-template-columns:1fr 1fr 1fr; 
      gap: 30px; 
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    @media (max-width: 700px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      background: var(--c-input);
      border: 1px solid var(--c-border);
      border-radius: var(--radius);
      padding: 24px;
      position: relative;
    }
    .kpi::before {
      content:''; position:absolute; top:0; left:24px; width:24px; height:3px; background:var(--c-bronze);
    }

    .kpi .t{font-size:11px; color:var(--c-muted); text-transform:uppercase; letter-spacing:0.5px;}
    
    .kpi-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-top: 12px;
    }
    .kpi .v{
      font-size: 36px; 
      font-weight: 300; 
      color: var(--c-cloud);
      font-family: var(--mono);
      line-height: 1;
    }
    .kpi .unit {
      font-size: 12px;
      font-weight: 600;
      color: var(--c-olive);
      letter-spacing: 0.5px;
    }
    
    .kpi .s{font-size:11px; color:var(--c-olive); margin-top:8px}

    /* 表格樣式 */
    .tblwrap{overflow:auto; border-top:1px solid var(--c-border)}
    table{width:100%; border-collapse:collapse; border-spacing:0}
    
    thead th{
      position:sticky; top:0;
      background: var(--c-card);
      border-bottom: 2px solid var(--c-bronze);
      font-size: 11px; 
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--c-bronze);
      text-align:left; padding: 16px 12px;
      white-space:nowrap;
    }

    tbody td{
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding: 14px 12px; font-size:13px; color:var(--c-cloud);
      white-space:nowrap;
      vertical-align:middle;
    }
    tbody tr:hover td{background: rgba(139, 111, 78, 0.05);}

    .mono{font-family:var(--mono)}

    .mini{
      padding: 8px 10px; border-radius: 4px; 
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--c-input); color: var(--c-cloud);
      width:100px;
      font-family:var(--mono);
      font-size:13px;
      text-align: right;
    }
    .mini:focus { border-color: var(--c-bronze); }

    .miniSel{
      padding: 8px; border-radius: 4px; 
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--c-input); color: var(--c-cloud);
      cursor: pointer;
    }

    .hidden-logic { display: none; }

    /* Tags */
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius: 4px;
      background: transparent;
      font-size: 11px; font-weight: 500;
      border: 1px solid transparent;
    }
    .tag.good { background: var(--s-good-bg); color: var(--s-good-fg); border-color: var(--s-good-fg); }
    .tag.warn { background: var(--s-warn-bg); color: var(--s-warn-fg); border-color: var(--s-warn-fg); }
    .tag.bad  { background: var(--s-bad-bg);  color: var(--s-bad-fg); }
    
    .tag.mini{padding: 2px 6px; font-size: 10px; text-transform: uppercase;}
    .tag.manual{ border: 1px dashed var(--c-bronze); color: var(--c-bronze); background: transparent; }

    .tagGroup{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
    .subgrid{display:flex; flex-direction:column; gap:4px;}
    .subline{font-size:11px; color:var(--c-muted); opacity: 0.7;}

    .footnote{margin-top:16px; color:var(--c-muted); font-size:12px; opacity:0.6;}
  </style>
</head>
<body>
  <div class="wrap">
    
    <div class="logo-container">
      <div class="logo-left-crop">
        <img class="logo-h" src="starlux-airlines-seeklogo.png" alt="Starlux Symbol" 
             onerror="alert('找不到圖片 starlux-airlines-seeklogo.png，請確認檔案位置');"/>
      </div>

      <div class="logo-right-crop">
        <img class="logo-h" src="starlux-airlines-seeklogo.png" alt="Starlux Text" />
      </div>
    </div>

    <div class="topnote">
      <b>備註：</b>此計算器若遇跨月美國班請自行手動修改津貼（月底最後一趟 days 可能需要你選）。<br/>
      本工具「總額」只涵蓋：飛行薪資（時薪 × 月 credit） + 津貼（餐費領取總和 + late night；當天來回用 dayturn）。
    </div>

    <div class="card">
      <h2>參數與班表文字</h2>
      <div class="content">
        <div class="row">
          <div>
            <label>時薪（TWD / 小時）</label>
            <input id="hourly" type="number" value="445" step="1" min="0" />
          </div>
          <div>
            <label>季別</label>
            <select id="season">
              <option value="winter" selected>冬季</option>
              <option value="summer">夏季</option>
            </select>
          </div>
          <div>
            <label>班表年月（YYYY-MM）</label>
            <input id="yyyymm" type="text" value="2025-12" placeholder="例如 2025-12" />
          </div>
          <div>
            <label>整月 credit（hh:mm）</label>
            <input id="monthCredit" type="text" value="87:44" placeholder="例如 82:04" />
          </div>
        </div>

        <div>
          <label>貼上你的班表文字（Apple Live Text / Copy / 手打都可）</label>
          <textarea id="rosterText" spellcheck="false" placeholder="貼上像這樣：
Mon 29
ANL
0000L
Fri 26
JX745|BKK
1135L
..."></textarea>
          <div class="footnote">
            小技巧：如果你看到 <span class="mono">JX741IBKK</span>、<span class="mono">JX822(KIX</span> 這種，把 <span class="mono">I</span> / <span class="mono">(</span> 當成 <span class="mono">|</span> 我會自動容錯。
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="btnCalc">解析 + 計算</button>
          <button id="btnExample">載入示範文字（12月）</button>
          <button id="btnClear">清空</button>
        </div>
        
        <div class="kpis">
          <div class="kpi">
            <div class="t">飛行薪資</div>
            <div class="kpi-row">
              <span class="v" id="kpiFlightPay">0</span>
              <span class="unit">NTD</span>
            </div>
            <div class="s" id="kpiFlightPaySub">credit = 0 小時</div>
          </div>
          <div class="kpi">
            <div class="t">津貼總額</div>
            <div class="kpi-row">
              <span class="v" id="kpiSubsidy">0</span>
              <span class="unit">NTD</span>
            </div>
            <div class="s" id="kpiSubsidySub">查表 + dayturn</div>
          </div>
          <div class="kpi" style="border-color: var(--c-bronze);">
            <div class="t" style="color:var(--c-bronze)">本月總計</div>
            <div class="kpi-row">
              <span class="v" id="kpiTotal" style="color:var(--c-bronze)">0</span>
              <span class="unit" style="color:var(--c-bronze)">NTD</span>
            </div>
          </div>
        </div>
        
        <div class="footnote" style="margin-top:12px">
          提示：你手動改過的那筆會出現 <span class="tag mini manual">手動</span> 標記。
        </div>

      </div>
    </div>

    <div class="card">
      <h2>逐趟明細</h2>
      <div class="tblwrap">
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>航班</th>
              <th>外站</th>
              <th>報到</th>
              <th>天數</th>
              <th>餐費 + 晚班</th>
              <th>津貼合計（可改）</th>
              <th>判定</th>
              <th class="mono">Key</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" class="footnote" style="text-align:center; padding:30px;">尚未解析。請在上方貼上文字後按「解析 + 計算」。</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="hidden-logic">
      <textarea id="tableJson"></textarea>
      <button id="btnResetTable">重置為內建表</button>
      <button id="btnValidateTable">檢查 JSON</button>
      <div id="tableMsg"></div>
    </div>

  </div>

<script>
/** ========= 0) 工具 ========= **/
const fmt = (n)=> {
  const x = Math.round((Number(n)||0));
  return x.toLocaleString('zh-Hant-TW');
};
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function parseHHMM(str){
  if(!str) return 0;
  const m = String(str).trim().match(/^(\d{1,3})\s*:\s*(\d{1,2})$/);
  if(!m) return 0;
  const h = Number(m[1]), mm = Number(m[2]);
  if(Number.isNaN(h)||Number.isNaN(mm)) return 0;
  return h + (mm/60);
}
function yyyymmIsValid(s){
  return /^\d{4}-\d{2}$/.test(String(s||'').trim());
}
function toISODate(yyyymm, day){
  const [Y,M] = yyyymm.split('-').map(Number);
  const d = new Date(Date.UTC(Y, M-1, Number(day), 0,0,0));
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth()+1).padStart(2,'0');
  const dd = String(d.getUTCDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function dateDiffDays(isoA, isoB){
  const a = new Date(isoA+'T00:00:00Z').getTime();
  const b = new Date(isoB+'T00:00:00Z').getTime();
  return Math.round((b-a)/(24*3600*1000));
}

/** ========= 1) 內建表 ========= **/
const DEFAULT_TABLE = {
  meal: {
    winter: {
      KUL: { "2": 3290, "3": 5640 },
      BKK: { "2": 3580 },
      CNX: { "2": 2530, "3": 4180 },
      CGK: { "2": 3590, "3": 6250 },
      PQC: { "3": 3900 },
      CTS: { "2": 3630 },
      SDJ: { "2": 3770 },
      HKD: { "3": 6460 },
      SIN: { "2": 4050 },
      NRT: { "2": 4160 },
      LAX: { "4": 7000, "5": 12000 },
      SFO: { "4": 7000 },
      SEA: { "4": 7000 },
      ONT: { "4": 7000, "5": 12000 },
      PHX: { "5": 12000, "6": 17000 }
    },
    summer: {
      KUL: { "2": 3290, "3": 5640 },
      BKK: { "2": 3580 },
      CNX: { "2": 2780, "3": 4130 },
      CGK: { "2": 3590, "3": 6250 },
      PQC: { "3": 3900 },
      CTS: { "2": 2690 },
      SDJ: { "2": 3770 },
      HKD: { "3": 6460 },
      SIN: { "2": 4050 },
      NRT: { "2": 4160 },
      LAX: { "4": 7000, "5": 12000 },
      SFO: { "4": 7000 },
      SEA: { "4": 7000 },
      ONT: { "4": 7000, "5": 12000 },
      PHX: { "5": 12000, "6": 17000 }
    }
  },
  late: {
    winter: {
      KUL: { "2": 250, "3": 250 },
      CGK: { "2": 250, "3": 250 },
      PQC: { "3": 250 },
      NRT: { "2": 250 },
      LAX: { "4": 250, "5": 500 },
      SFO: { "4": 500 },
      SEA: { "4": 250 },
      ONT: { "4": 250, "5": 250 },
      PHX: { "5": 250, "6": 250 },
      BKK: { }, CNX: { }, CTS: { }, SDJ: { }, HKD: { }, SIN: { }, SGN: { }
    },
    summer: {
      KUL: { "2": 250, "3": 250 },
      CGK: { "2": 250, "3": 250 },
      PQC: { "3": 250 },
      NRT: { "2": 250 },
      LAX: { "4": 250, "5": 500 },
      SFO: { "4": 500 },
      SEA: { "4": 250 },
      ONT: { "4": 250, "5": 250 },
      PHX: { "5": 250, "6": 250 },
      BKK: { }, CNX: { }, CTS: { }, SDJ: { }, HKD: { }, SIN: { }, SGN: { }
    }
  },
  special: {
    redEye: { US: 1800, CGK: 900 },
    nrtOnlyJX800GetsLate: true,
    lateOverrides: {
      "JX745|BKK": 250,
      "JX711|SGN": 250
    }
  }
};

/** ========= 2) 解析 roster text ========= **/
const WEEKDAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

function normalizeText(raw){
  let t = String(raw||"");
  t = t.replace(/O00O?L/gi, "0000L");
  t = t.replace(/000OL/gi, "0000L");
  t = t.replace(/\r/g,'\n');
  return t;
}

function parseJX(compact){
  const s = String(compact||"").toUpperCase();
  const m = s.match(/JX(\d{3})/);
  if(!m) return null;
  const num = m[1];
  const after = s.slice(m.index + 2 + 3);

  let dest = null;
  let m2 = after.match(/[\|\I\(\)\[\]\{\}\/\\\-\_]+([A-Z]{3})/);
  if(m2) dest = m2[1];
  if(!dest){
    const m3 = after.match(/^([A-Z]{3})/);
    if(m3) dest = m3[1];
  }
  if(!dest) return null;
  return { flight: `JX${num}`, dest };
}

function extractEvents(yyyymm, rawText){
  const txt = normalizeText(rawText);
  const lines = txt.split('\n').map(s=>s.trim()).filter(Boolean);
  const events = [];

  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    let wd = null;
    let day = null;
    let mSame = line.match(/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+(\d{1,2})$/);
    if(mSame){
      wd = mSame[1];
      day = Number(mSame[2]);
    }else{
      if(WEEKDAYS.includes(line)){
        const dayLine = lines[i+1] || "";
        const mDay = dayLine.match(/^(\d{1,2})$/);
        if(mDay){
          wd = line;
          day = Number(mDay[1]);
        }
      }
    }
    if(!wd || !day) continue;
    const iso = toISODate(yyyymm, day);
    let code = null;
    let time = null;
    const startOffset = mSame ? 1 : 2;
    for(let j=startOffset; j<=startOffset+5; j++){
      const s0 = lines[i+j] || "";
      if(!s0) continue;
      const mt = s0.match(/^(\d{3,4})L$/i);
      if(mt){
        time = mt[1].padStart(4,'0');
        continue;
      }
      const maybe = s0.replace(/\s+/g,'');
      if(!code){
        const jx = parseJX(maybe);
        if(jx){
          code = `${jx.flight}|${jx.dest}`;
          continue;
        }
        const mNon = maybe.match(/^([A-Z]{2,3}\d{0,2})$/);
        if(mNon){
          code = mNon[1].toUpperCase();
          continue;
        }
      }
    }
    if(code){
      events.push({ iso, day, weekday: wd, code, time: time ? `${time.slice(0,2)}:${time.slice(2,4)}` : "" });
    }
  }
  const seen = new Set();
  const uniq = [];
  for(const e of events){
    const k = `${e.iso}|${e.code}`;
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(e);
  }
  uniq.sort((a,b)=> a.iso.localeCompare(b.iso));
  return uniq;
}

/** ========= 3) 推天數 + 計算津貼 ========= **/
const US_DESTS = new Set(["LAX","SFO","SEA","ONT","PHX"]);
const DAYTURN_1200_DESTS = new Set(["MFM","CRK","HKG","OKA","SHI","MNL"]);
const DAYTURN_DEFAULT = 1750;
const DAYTURN_SPECIAL = 1200;

function isJXCode(code){
  return /^JX\d{3}\|[A-Z]{3}$/.test(code);
}
function splitJX(code){
  const m = String(code).match(/^(JX\d{3})\|([A-Z]{3})$/);
  if(!m) return null;
  return { flight:m[1], dest:m[2] };
}

function inferDaysForTrip(allEvents, tripIndex){
  const cur = allEvents[tripIndex];
  const curIso = cur.iso;
  for(let i=tripIndex+1;i<allEvents.length;i++){
    const nxt = allEvents[i];
    if(nxt.iso > curIso){
      const d = dateDiffDays(curIso, nxt.iso);
      if(d>=1) return { days:d, reason:"下一事件日推算" };
    }
  }
  return { days:null, reason:"月底最後一趟/缺下一事件" };
}

function loadTable(){
  const raw = document.getElementById('tableJson').value.trim();
  try{
    const obj = JSON.parse(raw);
    if(!obj.meal || !obj.late || !obj.special) throw new Error("JSON 缺少 meal/late/special");
    return { ok:true, data:obj };
  }catch(err){
    return { ok:false, error:String(err && err.message ? err.message : err) };
  }
}

function getLateOverride(table, flight, dest){
  const key = `${flight}|${dest}`;
  const ov = table.special?.lateOverrides?.[key];
  return (typeof ov === "number") ? ov : null;
}

function lookupMeal(table, season, dest, days){
  const s = table.meal?.[season]?.[dest];
  if(!s) return null;
  const v = s[String(days)];
  return (typeof v === 'number') ? v : null;
}

function lookupLate(table, season, dest, days, flight){
  const ov = getLateOverride(table, flight, dest);
  if(ov != null) return ov;
  if(dest==="NRT" && table.special?.nrtOnlyJX800GetsLate){
    if(flight !== "JX800") return 0;
  }
  const s = table.late?.[season]?.[dest];
  if(!s) return 0;
  const v = s[String(days)];
  return (typeof v === 'number') ? v : 0;
}

function computeSubsidyForTrip({season, table, flight, dest, days}){
  if(days===1){
    if(US_DESTS.has(dest)){
      return { subsidy: 0, key:`${season}.${dest}.1`, status:"防呆：美國線不可當日", tag:"bad", meal:0, late:0 };
    }
    const base = DAYTURN_1200_DESTS.has(dest) ? DAYTURN_SPECIAL : DAYTURN_DEFAULT;
    const late = getLateOverride(table, flight, dest) ?? 0;
    const total = base + late;
    const status = late ? `當日(${base}) + 晚班(${late})` : `當日(${base})`;
    return { subsidy: total, key:`${season}.${dest}.1`, status, tag:"good", meal:0, late, isDayturn:true };
  }
  const meal = lookupMeal(table, season, dest, days);
  const late = lookupLate(table, season, dest, days, flight);
  if(meal==null){
    return { subsidy: late||0, key:`${season}.${dest}.${days}`, status:"查不到", tag:"warn", meal:0, late:late||0 };
  }
  return { subsidy: meal + (late||0), key:`${season}.${dest}.${days}`, status:"查表", tag:"good", meal, late };
}

function computeRedEyeAdditions(table, trips){
  const usAdd = Number(table.special?.redEye?.US ?? 1800);
  const cgkAdd = Number(table.special?.redEye?.CGK ?? 900);
  let total = 0;
  let usCount = 0, cgkCount = 0;
  for(const t of trips){
    if(US_DESTS.has(t.dest)){ total += usAdd; usCount++; }
    if(t.dest==="CGK"){ total += cgkAdd; cgkCount++; }
  }
  return { total, usCount, cgkCount, usAdd, cgkAdd };
}

/** ========= 4) UI 狀態 ========= **/
let state = { events: [], trips: [] };

function buildTripsFromEvents(allEvents){
  const trips = [];
  for(let idx=0; idx<allEvents.length; idx++){
    const e = allEvents[idx];
    if(!isJXCode(e.code)) continue;
    const parts = splitJX(e.code);
    if(!parts) continue;
    trips.push({
      eventIndex: idx,
      iso: e.iso,
      flight: parts.flight,
      dest: parts.dest,
      time: e.time || "",
      days: null,
      daysReason: "",
      subsidy: 0,
      meal: 0,
      late: 0,
      key: "",
      status: "",
      tag: "warn",
      manualDays: false,
      manualSubsidy: false
    });
  }
  return trips;
}

function updateKpisOnly(){
  const hourly = Number(document.getElementById('hourly').value || 0);
  const creditH = parseHHMM(document.getElementById('monthCredit').value);
  const season = document.getElementById('season').value;
  const tb = loadTable();
  const table = tb.ok ? tb.data : DEFAULT_TABLE;
  const red = computeRedEyeAdditions(table, state.trips);
  const flightPay = hourly * creditH + red.total;
  const subsidySum = state.trips.reduce((a,b)=> a + (Number(b.subsidy)||0), 0);
  const total = flightPay + subsidySum;

  document.getElementById('kpiFlightPay').textContent = fmt(flightPay);
  document.getElementById('kpiFlightPaySub').textContent =
    `credit = ${creditH.toFixed(2)} 小時；紅眼/補貼：美國×${red.usCount}（每趟${red.usAdd}） + CGK×${red.cgkCount}（每趟${red.cgkAdd}）`;

  document.getElementById('kpiSubsidy').textContent = fmt(subsidySum);
  document.getElementById('kpiSubsidySub').textContent = "查表（餐費 + late） + dayturn";
  document.getElementById('kpiTotal').textContent = fmt(total);
}

function recalcAndRender(){
  const season = document.getElementById('season').value;
  const tb = loadTable();
  if(!tb.ok){
    document.getElementById('tableMsg').innerHTML = `<span style="color:var(--s-warn-fg)">JSON 解析失敗：${tb.error}</span>`;
  }else{
    document.getElementById('tableMsg').innerHTML = `<span style="color:var(--s-good-fg)">JSON OK</span>`;
  }
  const table = tb.ok ? tb.data : DEFAULT_TABLE;

  for(const t of state.trips){
    if(!t.manualDays){
      const inf = inferDaysForTrip(state.events, t.eventIndex);
      t.days = inf.days;
      t.daysReason = inf.reason;
    }
    if(t.days==null){
      t.subsidy = 0;
      t.meal = 0;
      t.late = 0;
      t.key = `${season}.${t.dest}.?`;
      t.status = "待確認";
      t.tag = "warn";
      continue;
    }
    if(US_DESTS.has(t.dest) && t.days===1){
      t.days = 2;
      t.daysReason = "防呆：美國線不可當日";
      t.manualDays = true;
    }
    const res = computeSubsidyForTrip({season, table, flight:t.flight, dest:t.dest, days:t.days});
    t.meal = Number(res.meal || 0);
    t.late = Number(res.late || 0);
    if(!t.manualSubsidy){
      t.subsidy = Number(res.subsidy || 0);
    }
    t.key = res.key;
    t.status = res.status;
    t.tag = res.tag;
  }
  updateKpisOnly();
  renderTripsTable();
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function renderTripsTable(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = "";
  if(state.trips.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="9" class="footnote" style="text-align:center; padding:30px;">
      沒有抓到任何 JX 航班。請確認貼上的文字包含 <span class="mono">JXxxx|XXX</span>（或 <span class="mono">JXxxxIXXX</span> / <span class="mono">JXxxx(XXX</span> 等容錯）。
    </td>`;
    tb.appendChild(tr);
    return;
  }
  for(let i=0;i<state.trips.length;i++){
    const t = state.trips[i];
    const tr = document.createElement('tr');
    let daysCell = "";
    if(t.days==null){
      daysCell = `
        <div class="subgrid">
          <select class="miniSel" data-i="${i}" data-act="days">
            <option value="" selected>待確認</option>
            ${Array.from({length:10}, (_,k)=>k+1).map(v=>`<option value="${v}">${v}</option>`).join("")}
          </select>
          <div class="subline">${escapeHtml(t.daysReason||"")}</div>
        </div>
      `;
    }else{
      const max = clamp(t.days,1,31);
      daysCell = `
        <div class="subgrid">
          <select class="miniSel" data-i="${i}" data-act="days">
            ${Array.from({length:10}, (_,k)=>k+1).map(v=>`<option value="${v}" ${v===max?'selected':''}>${v}</option>`).join("")}
          </select>
          <div class="subline">推算：${max} 天（${escapeHtml(t.daysReason||"—")}）</div>
        </div>
      `;
    }
    const totalInput = `
      <input class="mini" inputmode="numeric" pattern="[0-9]*" value="${Number(t.subsidy)||0}"
        data-i="${i}" data-act="subsidy" />
      <div class="subline">（Enter生效）</div>
    `;
    const tagClass = t.tag==="good" ? "tag good" : (t.tag==="bad" ? "tag bad" : "tag warn");
    const statusBadge = `<span class="${tagClass}">${escapeHtml(t.status||"—")}</span>`;
    const mealTag = `<span class="tag mini ${t.meal? "good":"bad"}">餐費 ${fmt(t.meal||0)}</span>`;
    const lateTag = `<span class="tag mini ${t.late? "good":"bad"}">晚班 ${fmt(t.late||0)}</span>`;
    const manualBadges = `
      ${t.manualSubsidy ? `<span class="tag mini manual">手動</span>` : ``}
      ${t.manualDays ? `<span class="tag mini manual">手動天數</span>` : ``}
    `;

    tr.innerHTML = `
      <td class="mono">${t.iso}</td>
      <td class="mono" style="color:var(--c-bronze)">${t.flight}</td>
      <td class="mono" style="font-weight:600">${t.dest}</td>
      <td class="mono" style="color:var(--c-muted)">${t.time || "—"}</td>
      <td>${daysCell}</td>
      <td>
        <div class="tagGroup">
          ${mealTag}
          ${lateTag}
        </div>
      </td>
      <td><div class="subgrid">${totalInput}</div></td>
      <td>
        <div class="tagGroup">
          ${statusBadge}
          ${manualBadges}
        </div>
      </td>
      <td class="mono" style="font-size:11px; opacity:0.6">${escapeHtml(t.key||"")}</td>
    `;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('[data-act="days"]').forEach(el=>{
    el.addEventListener('change', (e)=>{
      const idx = Number(e.target.getAttribute('data-i'));
      const val = e.target.value;
      if(!val){
        state.trips[idx].days = null;
        state.trips[idx].manualDays = true;
      }else{
        state.trips[idx].days = Number(val);
        state.trips[idx].manualDays = true;
      }
      state.trips[idx].manualSubsidy = false;
      recalcAndRender();
    });
  });
  tb.querySelectorAll('[data-act="subsidy"]').forEach(el=>{
    const commit = (target)=>{
      const idx = Number(target.getAttribute('data-i'));
      const raw = String(target.value||"").replace(/[^\d]/g,'');
      const num = raw ? Number(raw) : 0;
      state.trips[idx].subsidy = num;
      state.trips[idx].manualSubsidy = true;
      target.value = String(num);
      updateKpisOnly();
      renderTripsTable();
    };
    el.addEventListener('keydown', (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        commit(e.target);
        e.target.blur();
      }
    });
    el.addEventListener('blur', (e)=> commit(e.target));
  });
}

/** ========= 5) 主流程 ========= **/
function calc(){
  const yyyymm = document.getElementById('yyyymm').value.trim();
  if(!yyyymmIsValid(yyyymm)){
    alert("班表年月格式要是 YYYY-MM，例如 2025-12");
    return;
  }
  const raw = document.getElementById('rosterText').value;
  const events = extractEvents(yyyymm, raw);
  state.events = events;
  state.trips = buildTripsFromEvents(events);
  
  for(const t of state.trips){
    t.manualDays = false;
    t.manualSubsidy = false;
  }
  recalcAndRender();
}

/** ========= 6) Buttons ========= **/
document.getElementById('btnCalc').addEventListener('click', calc);
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('rosterText').value = "";
  state.events = [];
  state.trips = [];
  recalcAndRender();
});
document.getElementById('btnExample').addEventListener('click', ()=>{
  document.getElementById('yyyymm').value = "2025-12";
  document.getElementById('monthCredit').value = "87:44";
  document.getElementById('rosterText').value =
`Mon 29
ANL
0000L
Sun 28
DO
0000L
Sat 27
DO
Fri 26
JX745|BKK
1135L
Wed 24
JX802|NRT
0820L
Tue 23
SKL
0000L
Mon 22
DO
0000L
Wed 17
JX002|LAX
2150L
Tue 16
DO
Mon 15
DO
Sat 13
JX741IBKK
0735L
Fri 12
SH05
0500L
Wed 10
UH20
2000L
Tue 9
DO
0000L
Mon 8
DO
0000L
Sun 7
JX822|KIX
0730L
Sat 6
DO
0000L
Fri 5
JX822(KIX
0730L
Wed 3
JX741|BKK
0735L
Tue 2
DO
0000L
Mon 1
MTL
0000L`;
  calc();
});
document.getElementById('btnResetTable').addEventListener('click', ()=>{
  document.getElementById('tableJson').value = JSON.stringify(DEFAULT_TABLE, null, 2);
  recalcAndRender();
});
document.getElementById('btnValidateTable').addEventListener('click', ()=>{
  loadTable();
});
document.getElementById('season').addEventListener('change', recalcAndRender);
document.getElementById('hourly').addEventListener('input', updateKpisOnly);
document.getElementById('monthCredit').addEventListener('input', updateKpisOnly);

/** init */
document.getElementById('tableJson').value = JSON.stringify(DEFAULT_TABLE, null, 2);
recalcAndRender();
</script>
</body>
</html>